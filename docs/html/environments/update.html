<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Environments update &mdash; Interlink  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Environments administration" href="administration.html" />
    <link rel="prev" title="SW development, CI &amp; CD policies for INTERLINK software" href="cicd.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Interlink
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Environments</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Local (development) environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="stack.html">Overall stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="cicd.html">SW development, CI &amp; CD policies for INTERLINK software</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Environments update</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#demo-and-pilots">Demo and pilots</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generating-new-versions-of-the-components">Generating new versions of the components</a></li>
<li class="toctree-l3"><a class="reference internal" href="#when-to-update-demo-and-pilots">When to update demo and pilots</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="administration.html">Environments administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging Instruction for Microservices</a></li>
<li class="toctree-l2"><a class="reference internal" href="kpis.html">KPI obtention</a></li>
<li class="toctree-l2"><a class="reference internal" href="weblate.html">Weblate for continous localization</a></li>
<li class="toctree-l2"><a class="reference internal" href="google.html">Google keys</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../collaborativeenvironment/index.html">Collaborative environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/acceptance-tests/index.html">User Acceptance testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other_problems.html">Errors</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Interlink</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Environments</a></li>
      <li class="breadcrumb-item active">Environments update</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/environments/update.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="environments-update">
<h1>Environments update<a class="headerlink" href="#environments-update" title="Link to this heading"></a></h1>
<p>The demo and pilots are static instances of the platform. By this we mean that only the dev environment changes on a frequent basis, with the aim that developers see their changes in a different environment to the local, more production-like environment (in reality it is practically the same as production).</p>
<p>Once the dev environment is verified to be usable and stable (take a look at <a class="reference external" href="https://interlink-project.github.io/interlink-project/testing/acceptance-tests/index.html">Acceptance testing</a>), the demo and pilot environments should be updated to reflect the new changes.</p>
<p>To start with, when changes are made to any of the components enumerated in the <a class="reference external" href="https://interlink-project.github.io/interlink-project/environments/stack.html">Stack section</a>, a new Docker image of the component is generated and triggers the “update-dev-environment” workflow by sending an event to the interlink-project repository.</p>
<p>Let’s take backend-coproduction as an example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>name:<span class="w"> </span>build-and-publish-docker

on:
<span class="w">  </span>workflow_dispatch:
<span class="w">  </span>push:
<span class="w">    </span>tags:
<span class="w">      </span>-<span class="w"> </span><span class="s1">&#39;*&#39;</span>
<span class="w">    </span>branches:
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;master&quot;</span>

jobs:
<span class="w">  </span>docker:
<span class="w">    </span>runs-on:<span class="w"> </span>ubuntu-latest
<span class="w">    </span>steps:

<span class="w">        </span><span class="o">(</span>...<span class="o">)</span>

<span class="w">      </span>-<span class="w"> </span>name:<span class="w"> </span>Build<span class="w"> </span>and<span class="w"> </span>push<span class="w"> </span>Docker<span class="w"> </span>Image
<span class="w">        </span>id:<span class="w"> </span>docker_build
<span class="w">        </span>uses:<span class="w"> </span>docker/build-push-action@v2
<span class="w">        </span>with:
<span class="w">          </span>context:<span class="w"> </span>.
<span class="w">          </span>file:<span class="w"> </span>Dockerfile
<span class="w">          </span>push:<span class="w"> </span><span class="nb">true</span>
<span class="w">          </span>tags:<span class="w"> </span><span class="p">|</span>
<span class="w">            </span>projectgreengage/backend-coproduction:<span class="si">${</span><span class="p">{ github.ref_name </span><span class="si">}</span><span class="o">}</span>
<span class="w">            </span>projectgreengage/backend-coproduction:<span class="si">${</span><span class="p">{ github.ref_name </span><span class="si">}</span><span class="o">}</span>.<span class="si">${</span><span class="p">{ steps.date.outputs.date </span><span class="si">}</span><span class="o">}</span>
<span class="w">          </span>cache-from:<span class="w"> </span><span class="nv">type</span><span class="o">=</span>registry,ref<span class="o">=</span>projectgreengage/backend-coproduction:buildcache
<span class="w">          </span>cache-to:<span class="w"> </span><span class="nv">type</span><span class="o">=</span>registry,ref<span class="o">=</span>projectgreengage/backend-coproduction:buildcache,mode<span class="o">=</span>max

<span class="w">      </span>-<span class="w"> </span>name:<span class="w"> </span>Trigger<span class="w"> </span>Dev<span class="w"> </span>Deployment
<span class="w">        </span>uses:<span class="w"> </span>octokit/request-action@v2.x
<span class="w">        </span>id:<span class="w"> </span>trigger_dev_deployment
<span class="w">        </span>with:
<span class="w">          </span>route:<span class="w"> </span>POST<span class="w"> </span>/repos/<span class="o">{</span>owner<span class="o">}</span>/<span class="o">{</span>repo<span class="o">}</span>/dispatches
<span class="w">          </span>owner:<span class="w"> </span>interlink-project
<span class="w">          </span>repo:<span class="w"> </span>interlink-project
<span class="w">          </span>event_type:<span class="w"> </span>update-dev-environment
<span class="w">        </span>env:
<span class="w">          </span>GITHUB_TOKEN:<span class="w"> </span><span class="si">${</span><span class="p">{ secrets.GREENGAGE_PROJECT_GITHUB_TOKEN </span><span class="si">}</span><span class="o">}</span>
</pre></div>
</div>
<blockquote>
<div><p>“build-and-publish-docker” workflow in the backend-coproduction repository: <a class="reference external" href="https://github.com/interlink-project/backend-coproduction/blob/master/.github/workflows/build-and-publish-docker.yml">https://github.com/interlink-project/backend-coproduction/blob/master/.github/workflows/build-and-publish-docker.yml</a></p>
</div></blockquote>
<p>Update-dev-environment workflow, as well as the other workflows for the different environments (demo and pilots), is responsible for establishing an ssh connection to the server where the application is hosted and executing the commands needed to get the latest changes and start the docker services based on them.</p>
<p>The triggers for the dev workflow are as follows:</p>
<ul class="simple">
<li><p><strong>workflow_dispatch:</strong> to manually trigger a workflow run using the GitHub API, GitHub CLI, or GitHub browser interface.</p></li>
<li><p><strong>repository_dispatch:</strong> use the GitHub API to trigger a webhook event called repository_dispatch when you want to trigger a workflow for activity that happens outside of GitHub or, as it happens in this case, from other repositories. (used by the other components, such as backend-coproduction, the example above)</p></li>
<li><p><strong>push:</strong> Runs workflow when you push a commit or tag.</p></li>
<li><p><strong>release:</strong> runs workflow when release activity in your repository occurs.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>name:<span class="w"> </span>update-dev-environment
on:
<span class="w">  </span>workflow_dispatch:
<span class="w">  </span>repository_dispatch:
<span class="w">    </span>types:<span class="w"> </span><span class="o">[</span>update-dev-environment<span class="o">]</span>

<span class="w">  </span>release:
<span class="w">    </span>types:<span class="w"> </span><span class="o">[</span><span class="w"> </span>published<span class="w"> </span><span class="o">]</span>

<span class="w">  </span>push:
<span class="w">    </span>branches:
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;master&quot;</span>
<span class="w">    </span>paths:
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;.github/workflows/update-dev-environment.yml&quot;</span>
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;envs/development/**&quot;</span>

jobs:
<span class="w">  </span>deploy:
<span class="w">    </span><span class="c1"># Ensures that only one deploy task per branch/environment will run at a time.</span>
<span class="w">    </span>concurrency:
<span class="w">      </span>group:<span class="w"> </span>environment-<span class="si">${</span><span class="p">{ github.ref </span><span class="si">}</span><span class="o">}</span>-development
<span class="w">      </span>cancel-in-progress:<span class="w"> </span><span class="nb">true</span>
<span class="w">    </span>runs-on:<span class="w"> </span>ubuntu-latest
<span class="w">    </span>environment:<span class="w"> </span>dev
<span class="w">    </span>steps:
<span class="w">      </span>-<span class="w"> </span>name:<span class="w"> </span>Deploy<span class="w"> </span>Dev<span class="w"> </span>SSH
<span class="w">        </span>uses:<span class="w"> </span>appleboy/ssh-action@master
<span class="w">        </span>with:
<span class="w">          </span>host:<span class="w"> </span><span class="si">${</span><span class="p">{ secrets.DEV_HOST </span><span class="si">}</span><span class="o">}</span>
<span class="w">          </span>username:<span class="w"> </span><span class="si">${</span><span class="p">{ secrets.DEV_USERNAME </span><span class="si">}</span><span class="o">}</span>
<span class="w">          </span>key:<span class="w"> </span><span class="si">${</span><span class="p">{ secrets.SSH_KEY </span><span class="si">}</span><span class="o">}</span>
<span class="w">          </span>script:<span class="w"> </span><span class="p">|</span>
<span class="w">            </span><span class="nb">export</span><span class="w"> </span><span class="nv">LOOMIO_SMTP_USERNAME</span><span class="o">=</span><span class="si">${</span><span class="p">{ secrets.LOOMIO_SMTP_USERNAME </span><span class="si">}</span><span class="o">}</span>
<span class="w">            </span><span class="nb">export</span><span class="w"> </span><span class="nv">LOOMIO_AAC_APP_SECRET</span><span class="o">=</span><span class="si">${</span><span class="p">{ secrets.LOOMIO_AAC_APP_SECRET </span><span class="si">}</span><span class="o">}</span>
<span class="w">            </span><span class="nb">export</span><span class="w"> </span><span class="nv">MAIL_PASSWORD</span><span class="o">=</span><span class="si">${</span><span class="p">{ secrets.DEV_MAIL_PASSWORD </span><span class="si">}</span><span class="o">}</span>
<span class="w">            </span><span class="nb">export</span><span class="w"> </span><span class="nv">LOOMIO_SECRET_COOKIE_TOKEN</span><span class="o">=</span><span class="si">${</span><span class="p">{ secrets.LOOMIO_SECRET_COOKIE_TOKEN </span><span class="si">}</span><span class="o">}</span>
<span class="w">            </span><span class="nb">export</span><span class="w"> </span><span class="nv">LOOMIO_SMTP_PASSWORD</span><span class="o">=</span><span class="si">${</span><span class="p">{ secrets.LOOMIO_SMTP_PASSWORD </span><span class="si">}</span><span class="o">}</span>
<span class="w">            </span><span class="nb">export</span><span class="w"> </span><span class="nv">LOOMIO_DEVISE_SECRET</span><span class="o">=</span><span class="si">${</span><span class="p">{ secrets.LOOMIO_DEVISE_SECRET </span><span class="si">}</span><span class="o">}</span>
<span class="w">            </span><span class="nb">export</span><span class="w"> </span><span class="nv">LOOMIO_DEVISE_SECRET</span><span class="o">=</span><span class="si">${</span><span class="p">{ secrets.LOOMIO_DEVISE_SECRET </span><span class="si">}</span><span class="o">}</span>
<span class="w">            </span><span class="o">(</span>...<span class="o">)</span>
<span class="w">            </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/interlink-project/interlink-project.git<span class="w"> </span>/datadrive/data/interlink-project<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">            </span><span class="nb">cd</span><span class="w"> </span>/datadrive/data/interlink-project/envs/development
<span class="w">            </span>git<span class="w"> </span>fetch<span class="w"> </span>--force<span class="w"> </span>--all<span class="w"> </span>--tags
<span class="w">            </span>git<span class="w"> </span>checkout<span class="w"> </span>origin/<span class="si">${</span><span class="p">{ github.ref_name </span><span class="si">}</span><span class="o">}</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span><span class="si">${</span><span class="p">{ github.ref_name </span><span class="si">}</span><span class="o">}</span>
<span class="w">            </span>pip3<span class="w"> </span>install<span class="w"> </span>python-dotenv<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>python3<span class="w"> </span>setup-dremio.py
<span class="w">            </span>docker-compose<span class="w"> </span>pull
<span class="w">            </span>docker<span class="w"> </span>network<span class="w"> </span>create<span class="w"> </span>traefik-public<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">            </span>docker<span class="w"> </span>network<span class="w"> </span>create<span class="w"> </span>grafana-network<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">            </span>docker-compose<span class="w"> </span>up<span class="w"> </span>-d
<span class="w">            </span>sleep<span class="w"> </span><span class="m">10</span>

<span class="w">            </span>docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-T<span class="w"> </span>catalogue<span class="w"> </span>python<span class="w"> </span>/app/app/pre_start.py
<span class="w">            </span>docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-T<span class="w"> </span>coproduction<span class="w"> </span>python<span class="w"> </span>/app/app/pre_start.py

<span class="w">            </span><span class="c1"># Apply last migrations (if they exist)</span>
<span class="w">            </span>docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-T<span class="w"> </span>catalogue<span class="w"> </span>alembic<span class="w"> </span>upgrade<span class="w"> </span>head
<span class="w">            </span>docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-T<span class="w"> </span>coproduction<span class="w"> </span>alembic<span class="w"> </span>upgrade<span class="w"> </span>head

<span class="w">            </span><span class="c1"># Seed the database (if objects already exist, initial_data.py script updates them)</span>
<span class="w">            </span>docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-T<span class="w"> </span>catalogue<span class="w"> </span>./seed.sh
<span class="w">            </span>docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-T<span class="w"> </span>coproduction<span class="w"> </span>./seed.sh
</pre></div>
</div>
<blockquote>
<div><p>Update-dev-environment workflow: <a class="reference external" href="https://github.com/interlink-project/interlink-project/blob/master/.github/workflows/update-dev-environment.yml">https://github.com/interlink-project/interlink-project/blob/master/.github/workflows/update-dev-environment.yml</a></p>
</div></blockquote>
<p>This way, every time a change is made to the master of any of the components, the dev environment is automatically updated (it takes about 3 minutes to generate the docker image and another 3 minutes to update the environment).</p>
<section id="demo-and-pilots">
<h2>Demo and pilots<a class="headerlink" href="#demo-and-pilots" title="Link to this heading"></a></h2>
<p>The workflows for updating demo and pilots are similar to the one for updating dev. The only change are the triggers; they can now only be executed manually (workflow_dispatch).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>name:<span class="w"> </span>update-demo-environment
on:
<span class="w">  </span>workflow_dispatch:

jobs:
<span class="w">  </span>deploy:
<span class="w">    </span><span class="c1"># Ensures that only one deploy task per branch/environment will run at a time.</span>
<span class="w">    </span>concurrency:
<span class="w">      </span>group:<span class="w"> </span>environment-<span class="si">${</span><span class="p">{ github.ref </span><span class="si">}</span><span class="o">}</span>-demo
<span class="w">      </span>cancel-in-progress:<span class="w"> </span><span class="nb">true</span>
<span class="w">    </span>runs-on:<span class="w"> </span>ubuntu-latest
<span class="w">    </span>environment:<span class="w"> </span>demo
<span class="w">    </span>steps:
<span class="w">      </span>-<span class="w"> </span>name:<span class="w"> </span>Deploy<span class="w"> </span>Demo<span class="w"> </span>SSH
<span class="w">        </span>uses:<span class="w"> </span>appleboy/ssh-action@master
<span class="w">        </span>with:
<span class="w">          </span>host:<span class="w"> </span><span class="si">${</span><span class="p">{ secrets.DEMO_HOST </span><span class="si">}</span><span class="o">}</span>
<span class="w">          </span>username:<span class="w"> </span><span class="si">${</span><span class="p">{ secrets.DEMO_USERNAME </span><span class="si">}</span><span class="o">}</span>
<span class="w">          </span><span class="o">(</span>...<span class="o">)</span>
</pre></div>
</div>
<blockquote>
<div><p>Update-demo-environment workflow: <a class="reference external" href="https://github.com/interlink-project/interlink-project/blob/master/.github/workflows/update-demo-environment.yml">https://github.com/interlink-project/interlink-project/blob/master/.github/workflows/update-demo-environment.yml</a></p>
</div></blockquote>
<p>One important consideration here is the “.env” file. As you can see in the docker-compose files, the versions of the services are defined by a variable. This variable is retrieved from the “.env” file.</p>
<p>Fragment of the docker-compose used in ALL the environments:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3.9&quot;</span>
<span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>

<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">frontend</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectgreengage/frontend:${FRONTEND_VERSION}</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>

<span class="w w-Error">  </span><span class="nt">googledrive</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectgreengage/interlinker-googledrive:${GOOGLEDRIVE_VERSION}</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>

<span class="w">  </span><span class="nt">ceditor</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectgreengage/interlinker-ceditor:ceditor.${CEDITOR_VERSION}</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>

<span class="w">  </span><span class="nt">augmenterservice</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectgreengage/publicservice-servicepedia:augmenterservice.${AUGMENTERSERVICE_VERSION}</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>

<span class="w">  </span><span class="nt">logging</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">projectgreengage/backend-logging:${LOGGING_VERSION}</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>
</div>
<p>Fragment of the env file of dev environment: <a class="reference external" href="https://github.com/interlink-project/interlink-project/blob/master/envs/development/.env">https://github.com/interlink-project/interlink-project/blob/master/envs/development/.env</a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">MAIN_DOMAIN</span><span class="o">=</span>interlink-project.eu
<span class="nv">DOMAIN</span><span class="o">=</span>dev.interlink-project.eu
<span class="nv">PLATFORM_STACK_NAME</span><span class="o">=</span>development
<span class="o">(</span>...<span class="o">)</span>

<span class="nv">FRONTEND_VERSION</span><span class="o">=</span>master
<span class="nv">DB_VERSION</span><span class="o">=</span>master
<span class="nv">COPRODUCTION_VERSION</span><span class="o">=</span>master
<span class="nv">CATALOGUE_VERSION</span><span class="o">=</span>master
<span class="nv">AUTH_VERSION</span><span class="o">=</span>master
<span class="nv">GOOGLEDRIVE_VERSION</span><span class="o">=</span>master
<span class="nv">SURVEYEDITOR_VERSION</span><span class="o">=</span>master
<span class="nv">CEDITOR_VERSION</span><span class="o">=</span>master
<span class="nv">ETHERPAD_VERSION</span><span class="o">=</span>master
<span class="nv">LOOMIO_VERSION</span><span class="o">=</span>master
<span class="nv">LOOMIOWORKER_VERSION</span><span class="o">=</span>master
<span class="nv">AUGMENTERSERVICE_VERSION</span><span class="o">=</span>master
<span class="nv">LOGGING_VERSION</span><span class="o">=</span>master
<span class="nv">GRAFANA_VERSION</span><span class="o">=</span>master
<span class="nv">PROMETHEUS_VERSION</span><span class="o">=</span>master
<span class="nv">LOKI_VERSION</span><span class="o">=</span>master
<span class="nv">PROMTAIL_VERSION</span><span class="o">=</span>master
<span class="nv">FILEBEAT_VERSION</span><span class="o">=</span>master
</pre></div>
</div>
<p>Fragment of the env file of demo environment: <a class="reference external" href="https://github.com/interlink-project/interlink-project/blob/master/envs/demo/.env">https://github.com/interlink-project/interlink-project/blob/master/envs/demo/.env</a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">MAIN_DOMAIN</span><span class="o">=</span>interlink-project.eu
<span class="nv">DOMAIN</span><span class="o">=</span>demo.interlink-project.eu
<span class="nv">PLATFORM_STACK_NAME</span><span class="o">=</span>demo
<span class="o">(</span>...<span class="o">)</span>

<span class="nv">FRONTEND_VERSION</span><span class="o">=</span>v1.2.5
<span class="nv">DB_VERSION</span><span class="o">=</span>v1.0.6
<span class="nv">COPRODUCTION_VERSION</span><span class="o">=</span>v1.2.6
<span class="nv">CATALOGUE_VERSION</span><span class="o">=</span>v1.2.2
<span class="nv">AUTH_VERSION</span><span class="o">=</span>v1.0.5
<span class="nv">GOOGLEDRIVE_VERSION</span><span class="o">=</span>v1.0.9
<span class="nv">SURVEYEDITOR_VERSION</span><span class="o">=</span>v1.0.1
<span class="nv">CEDITOR_VERSION</span><span class="o">=</span>v1.0.1
<span class="nv">ETHERPAD_VERSION</span><span class="o">=</span>v1.0.0
<span class="nv">LOOMIO_VERSION</span><span class="o">=</span>common.v1.0.0
<span class="nv">LOOMIOWORKER_VERSION</span><span class="o">=</span>common.v1.0.0
<span class="nv">AUGMENTERSERVICE_VERSION</span><span class="o">=</span>v1.1.17
<span class="nv">LOGGING_VERSION</span><span class="o">=</span>v1.1.1
<span class="nv">GRAFANA_VERSION</span><span class="o">=</span>v1.0.2
<span class="nv">PROMETHEUS_VERSION</span><span class="o">=</span>v1.0.2
<span class="nv">LOKI_VERSION</span><span class="o">=</span>v1.0.2
<span class="nv">PROMTAIL_VERSION</span><span class="o">=</span>v1.0.2
<span class="nv">FILEBEAT_VERSION</span><span class="o">=</span>v1.0.2
</pre></div>
</div>
<p>The string “master” (in dev) refers to the latest docker image available, while in demo, it refers to specific versions of each component. So, logically, every time the dev workflow is executed, the services will be started in their latest version, while it doesn’t matter how many times or at what time the demo workflow is executed, as it will depend on the versions specified in the .env file.</p>
<p>Therefore, the following explains how to generate new versions (tags) of the components.</p>
</section>
<section id="generating-new-versions-of-the-components">
<h2>Generating new versions of the components<a class="headerlink" href="#generating-new-versions-of-the-components" title="Link to this heading"></a></h2>
<p>Going back to the component workflow, like the backend-coproduction workflow presented above, it creates an image with the master name on each push of a commit, but in case of a tag push, it creates an image with the name assigned to the tag. This happens thanks to the ${{ github.ref_name }} variable.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>name:<span class="w"> </span>build-and-publish-docker

on:
<span class="w">  </span>workflow_dispatch:
<span class="w">  </span>push:
<span class="w">    </span>tags:
<span class="w">      </span>-<span class="w"> </span><span class="s1">&#39;*&#39;</span>
<span class="w">    </span>branches:
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;master&quot;</span>
<span class="w">      </span><span class="o">(</span>...<span class="o">)</span>

<span class="w">      </span>-<span class="w"> </span>name:<span class="w"> </span>Build<span class="w"> </span>and<span class="w"> </span>push<span class="w"> </span>Docker<span class="w"> </span>Image
<span class="w">        </span>id:<span class="w"> </span>docker_build
<span class="w">        </span>uses:<span class="w"> </span>docker/build-push-action@v2
<span class="w">        </span>with:
<span class="w">          </span>context:<span class="w"> </span>.
<span class="w">          </span>file:<span class="w"> </span>Dockerfile
<span class="w">          </span>push:<span class="w"> </span><span class="nb">true</span>
<span class="w">          </span>tags:<span class="w"> </span><span class="p">|</span>
<span class="w">            </span>projectgreengage/backend-coproduction:<span class="si">${</span><span class="p">{ github.ref_name </span><span class="si">}</span><span class="o">}</span>
<span class="w">            </span>projectgreengage/backend-coproduction:<span class="si">${</span><span class="p">{ github.ref_name </span><span class="si">}</span><span class="o">}</span>.<span class="si">${</span><span class="p">{ steps.date.outputs.date </span><span class="si">}</span><span class="o">}</span>
<span class="w">          </span>cache-from:<span class="w"> </span><span class="nv">type</span><span class="o">=</span>registry,ref<span class="o">=</span>projectgreengage/backend-coproduction:buildcache
<span class="w">          </span>cache-to:<span class="w"> </span><span class="nv">type</span><span class="o">=</span>registry,ref<span class="o">=</span>projectgreengage/backend-coproduction:buildcache,mode<span class="o">=</span>max
<span class="w">    </span><span class="o">(</span>...<span class="o">)</span>
</pre></div>
</div>
<blockquote>
<div><p>Backend-coproduction repository “build-and-publish-docker” workflow: <a class="reference external" href="https://github.com/interlink-project/backend-coproduction/blob/master/.github/workflows/build-and-publish-docker.yml">https://github.com/interlink-project/backend-coproduction/blob/master/.github/workflows/build-and-publish-docker.yml</a></p>
</div></blockquote>
<p>To create a tag in a given component:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/backend-coproduction
<span class="c1"># check existent tags</span>
git<span class="w"> </span>tag
<span class="c1"># create a new tag</span>
git<span class="w"> </span>tag<span class="w"> </span>-a<span class="w"> </span>v1.2.1<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;message&quot;</span>
<span class="c1"># push the tag</span>
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>v1.2.1
</pre></div>
</div>
<p>Results:</p>
<ul class="simple">
<li><p>Multiple tags for every component: <a class="reference external" href="https://github.com/interlink-project/backend-coproduction/tags">https://github.com/interlink-project/backend-coproduction/tags</a></p></li>
<li><p>Different docker images for each component: <a class="reference external" href="https://hub.docker.com/r/projectgreengage/backend-coproduction/tags">https://hub.docker.com/r/projectgreengage/backend-coproduction/tags</a></p></li>
</ul>
</section>
<section id="when-to-update-demo-and-pilots">
<h2>When to update demo and pilots<a class="headerlink" href="#when-to-update-demo-and-pilots" title="Link to this heading"></a></h2>
<p>Once dev seems to work properly, we may generate new tags for every component that has been modified. Then, we must update the .env file to replace the old versions with the new ones and make the necessary changes to the other files if needed (docker-compose, .env, frontend-customization…). After all the above, execute the update-demo-workflow manually.</p>
<p>Once the acceptance test has been performed in demo, we will proceed to do the same in the pilots, modifying the necessary files (docker-compose, .env, frontend-customization…) and execute the specific workflow manually.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="cicd.html" class="btn btn-neutral float-left" title="SW development, CI &amp; CD policies for INTERLINK software" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="administration.html" class="btn btn-neutral float-right" title="Environments administration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Interlink team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>