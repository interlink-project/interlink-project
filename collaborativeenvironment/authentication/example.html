<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auth flow example &mdash; Interlink  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/togglebutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Authentication" href="../datamodel/index.html" />
    <link rel="prev" title="Auth microservice" href="microservice.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Interlink
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../environments/index.html">Environments</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Collaborative environment</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../frontend.html">Frontend</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="authentication.html">Authentication</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="microservice.html">Auth microservice</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Auth flow example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../datamodel/index.html">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internationalization.html">Translation files manipulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing.html">Testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/acceptance-tests/index.html">User Acceptance testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other_problems.html">Errors</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Interlink</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Collaborative environment</a> &raquo;</li>
          <li><a href="authentication.html">Authentication</a> &raquo;</li>
      <li>Auth flow example</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/collaborativeenvironment/authentication/example.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="auth-flow-example">
<h1>Auth flow example<a class="headerlink" href="#auth-flow-example" title="Permalink to this heading"></a></h1>
<ol class="arabic simple">
<li><p>User has not logged in yet (there is no cookie).</p></li>
</ol>
<blockquote>
<div><p>![Auth1](images/auth/auth1.png)</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>After making a GET request to /auth/login, if user is not logged in, browser redirects to the OIDC service where the user can log in with credentials or third party providers, such as Google.</p></li>
</ol>
<blockquote>
<div><p>![Login](images/auth/login.png)</p>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>After a successful login, token is stored as a “samesite” cookie. Now, all requests made to the backend microservices behind <strong>localhost</strong> (or the site where is running the <strong>auth</strong> microservice) send the cookie together with the request.</p></li>
</ol>
<blockquote>
<div><p>![Auth2](images/auth/merged.jpg)</p>
</div></blockquote>
<p>### How do microservices check that a request is authenticated?</p>
<ul>
<li><p>Each endpoint checks if the access token is present <strong>as a cookie or as an authorization header</strong> (being prioritized the cookie), checks its validity and decodes it to set the <em>user_data</em> (contained inside the access token, having name, email and profile image, for example) inside <strong>request</strong> data</p>
<p>![Auth deps](images/auth/deps.png)</p>
</li>
</ul>
<p>## Advantages and drawbacks of cookie authentication</p>
<p>To understand the advantages of this authentication we must really understand how the different services are integrated in the frontend. If we look again at the example of how the interlinker <strong>forum</strong> is integrated into the frontend, we will see that it is done through an iframe that loads the path “/forum/assets/{id}/viewer/”.</p>
<p>![Forum integration](images/interlinkers/forumintegration.png)</p>
<p>&lt;iframe src=”/forum/assets/{id}/viewer/” frameBorder=”0”&gt;&lt;/iframe&gt;</p>
<p>### Alternatives (“authorization” header):</p>
<ul class="simple">
<li><p>That each service / interlinker integrate its own authentication flow (being complex both to develop and maintain). Likewise, it would entail that the user had to perform the login steps for and for each of the external services that are being injected into the main frontend. <strong>In fact, it would not be possible, because the OIDC provider does not support its loading inside an iframe</strong>.</p></li>
<li><p>We should find a plausible way to pass the access token to the service contained in the iframe. One way to do this would be to inject it as a parameter in the iframe’s src, which would expose the token:</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">&lt;iframe</span> <span class="pre">src=&quot;/forum/assets/{id}/viewer?access_token={access_token}&quot;&gt;&lt;/iframe&gt;</span>
<span class="pre">`</span></code></p>
<p>### Advantages of using cookie-based auth:</p>
<blockquote>
<div><ul class="simple">
<li><p>Once a user has logged in once, through any service (main frontend or interlinker GUIs), ALL the services can make authenticated requests.</p></li>
<li><p>Logic to implement authentication in any service is trivial and <strong>not framework-dependant</strong>. Given <strong>forum</strong> interlinker as an example, which is developed with NextJS framework, the logic to authenticate an user would be as simple as redirecting the user to the /auth/login route (the auth microservice is responsible to retrieve the token and to set it to a samesite cookie):</p></li>
</ul>
<p>![Auth2](images/auth/nextjs.png)</p>
<p>(being <em>auth</em> object an user_data “storage object” in order to access it fastly)</p>
<ul class="simple">
<li><p>By the way, <strong>authentication through authorization headers is also allowed (check AuthMiddleware)</strong></p></li>
</ul>
</div></blockquote>
<p>### Drawbacks:</p>
<blockquote>
<div><ul class="simple">
<li><p>All services MUST BE behind the same sitename (being allowed subdomains). In development, this is achieved by the <strong>proxy</strong> microservice, powered by Traefik (take a look in [ROUTING.md](/docs/ROUTING.md)).</p></li>
</ul>
</div></blockquote>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="microservice.html" class="btn btn-neutral float-left" title="Auth microservice" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../datamodel/index.html" class="btn btn-neutral float-right" title="Authentication" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Interlink team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>